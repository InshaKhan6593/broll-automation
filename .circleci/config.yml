version: 2.1

jobs:
  build-mac:
    macos:
      xcode: "15.4.0"
    resource_class: macos.m1.medium.gen1
    steps:
      - checkout
      - run:
          name: Setup Python
          command: |
            brew install python@3.12
            echo 'export PATH="/opt/homebrew/opt/python@3.12/bin:$PATH"' >> $BASH_ENV
      - run:
          name: Install Python dependencies
          command: |
            pip3 install -r requirements.txt
            pip3 install pyinstaller
      - run:
          name: Bundle backend
          command: python3 desktop/bundle_backend.py
      - run:
          name: Setup Node.js
          command: |
            brew install node@20
            echo 'export PATH="/opt/homebrew/opt/node@20/bin:$PATH"' >> $BASH_ENV
      - run:
          name: Build frontend
          command: |
            cd frontend
            npm install
            npm run build
      - run:
          name: Copy frontend to renderer
          command: |
            mkdir -p desktop/renderer
            cp -r frontend/dist/* desktop/renderer/
      - run:
          name: Install Electron deps
          command: |
            cd desktop
            npm install
      - run:
          name: Build Electron app
          command: |
            cd desktop
            npm run dist
      - store_artifacts:
          path: desktop/dist
          destination: mac-app

workflows:
  build-macos:
    jobs:
      - build-mac
